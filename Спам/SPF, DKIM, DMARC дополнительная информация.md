
**SPF: Механизмы и квалификаторы**.

**SPF (Sender Policy Framework)** — это система аутентификации электронной почты, которая позволяет владельцу домена указать, какие почтовые серверы имеют право отправлять письма от имени этого домена.  Это достигается путем публикации специальной SPF-записи в DNS.  

*Структура SPF-записи*
SPF-запись всегда начинается с `v=spf1` и далее содержит список механизмов и квалификаторов, которые определяют правила проверки:
- `include:`:  Включает SPF-запись другого домена.  Это основной механизм для делегирования прав отправки писем сторонним сервисам.  Например, `include:_spf.google.com` разрешает Google отправлять письма от имени вашего домена.  Важно понимать, что include механизм подтягивает всю SPF запись указанного домена, включая его include механизмы.  Это может привести к превышению лимита DNS-запросов (10), если в цепочке include слишком много доменов.  Именно поэтому важно понимать зависимость записей между корневым доменом и подключаемыми через include.
- `a:`:  Соответствует A-записи домена или указанного хоста.  Разрешает отправку с IP-адресов, связанных с A-записью.
- `mx:`:  Соответствует MX-записи домена или указанного хоста.  Разрешает отправку с IP-адресов почтовых серверов, указанных в MX-записи.
- `ptr:`:  (Не рекомендуется)  Выполняет обратный DNS-запрос для IP-адреса отправляющего сервера и проверяет, соответствует ли результат указанному домену.  Этот механизм считается устаревшим и ненадежным.
- `exists:`:  Проверяет существование A-записи для указанного домена.  Используется редко и может быть сложным для настройки.
- `all:`:  Этот механизм обязателен и должен быть последним в SPF-записи. Он определяет, что делать, если ни один из предыдущих механизмов не совпал.  
Квалификаторы:
-  `:  Pass.`  Явно разрешает отправку.  Используется по умолчанию, если квалификатор не указан.
-  `-:  Fail.`  Явно запрещает отправку.
-  `~:  Softfail.`  Отправка не рекомендуется, но письмо может быть доставлено.
-  `?:  Neutral.`  Нейтральное отношение.  По сути, то же самое, что и отсутствие квалификатора.

**Пример 1**:
`v=spf1 include:_spf.google.com include:sendgrid.net -all` - Эта запись разрешает отправку писем с серверов Google и SendGrid, а все остальные серверы блокируются.   

**Практический пример**: 
Допустим, у тебя домен example.com. Ты используешь Google Workspace для почты и SendGrid для рассылки.  Тогда твоя SPF-запись может выглядеть так: 
`v=spf1 include:_spf.google.com include:sendgrid.net -all`

Теперь давай перейдем к практическому заданию.  Представь, что ты настроил SPF-запись для домена example.net: `v=spf1 a:mail.example.net include:_spf.google.com -all`, но письма, отправленные непосредственно с сервера mail.example.net, попадают в спам.  Как ты будешь диагностировать и решать эту проблему?   

Диагностика: 
1. Проверка A-записи: Первым делом нужно убедиться, что A-запись `mail.example.net` действительно указывает на IP-адрес твоего почтового сервера.  Это можно сделать с помощью команды nslookup mail.example.net или онлайн-сервисов проверки DNS.
2. Проверка SPF-записи Google:  Механизм `include:_spf.google.com` подтягивает SPF-запись Google.  Убедись, что твой сервер `mail.example.net` не пытается отправлять письма через Google.  Если это так, то SPF-запись Google может быть причиной проблем. 
3. Проверка логов почтового сервера:  Проверь логи своего почтового сервера на наличие ошибок, связанных с отправкой писем.  Это может дать дополнительные подсказки о причине проблемы.  

Решение:
Если A-запись mail.example.net верна и сервер не отправляет письма через Google, то проблема, скорее всего, в том, что IP-адрес сервера mail.example.net не соответствует A-записи mail.example.net.  В этом случае нужно:
1. Исправить A-запись:  Убедиться, что A-запись mail.example.net указывает на правильный IP-адрес твоего почтового сервера.
2. Использовать механизм ip4:  Добавить механизм ip4 в SPF-запись, явно указав IP-адрес или диапазон IP-адресов твоего почтового сервера.  Например: `v=spf1 a:mail.example.net ip4:xxx.xxx.xxx.xxx include:_spf.google.com -all, где xxx.xxx.xxx.xxx - IP-адрес твоего сервера.`

Дополнительные рекомендации:
- Используй `mx` вместо `a`:  Если твой сервер mail.example.net также указан в MX-записи домена example.net, то лучше использовать механизм mx вместо a:  `v=spf1 mx include:_spf.google.com -all`.  Это упростит настройку и сделает ее более гибкой.
- Проверяй SPF-запись:  После внесения изменений всегда проверяй SPF-запись с помощью онлайн-сервисов, чтобы убедиться в ее корректности.


**Диагностика и устранение проблем с SPF.**

Инструменты для проверки SPF:
- [MxToolbox](https://mxtoolbox.com/):  Популярный инструмент для проверки различных DNS-записей, включая SPF. Предоставляет подробную информацию о результатах проверки.
- Kitterman:  Еще один удобный инструмент для проверки SPF и других DNS-записей.
- Dmarcian:  Более продвинутый инструмент, который предоставляет аналитику DMARC, но также может быть использован для проверки SPF.

Типичные ошибки настройки SPF и их исправление:
1. **Превышение лимита DNS-запросов (10 lookups)**:  Эта ошибка возникает, когда в цепочке include слишком много доменов.  Каждый include генерирует DNS-запрос, и если их количество превышает 10, проверка SPF завершается ошибкой. **Решение**:  Оптимизируй SPF-запись, уменьшив количество include.  Объединяй несколько сервисов в одну SPF-запись, если это возможно.  Используй механизмы a и mx вместо include, если это применимо.  Внимательно следи за тем, какие записи подтягиваются через include - возможно, некоторые из них содержат лишние include, которые можно исключить. 
2. **Неправильное использование квалификатора all**:  Квалификатор all должен быть последним в SPF-записи.  Если он отсутствует или расположен не в конце, проверка SPF может работать некорректно. **Решение**:  Убедись, что квалификатор all присутствует и находится в конце SPF-записи.  Рекомендуется использовать -all для явного запрета отправки с неавторизованных серверов. 
3. **Неправильное использование механизма ptr**:  Механизм ptr считается устаревшим и ненадежным.  **Его использование не рекомендуется**. **Решение**:  Замени ptr на a или mx, если это возможно.  Если использование ptr необходимо, убедись, что обратный DNS настроен корректно. 
4. **Отсутствие SPF-записи**:  Если SPF-запись отсутствует, любой сервер может отправлять письма от имени твоего домена. **Решение**:  Создай SPF-запись для своего домена.  Даже простая запись `v=spf1 -all` лучше, чем ее отсутствие.
5. **Неправильный IP-адрес в механизме ip4 или ip6**: Если указан неверный IP-адрес, письма с легитимных серверов могут быть заблокированы. **Решение**:  Перепроверь IP-адреса, указанные в механизмах ip4 и ip6.  Убедись, что они соответствуют IP-адресам твоих почтовых серверов.

**Пример анализа SPF-записи:**
Допустим, у тебя есть SPF-запись: `v=spf1 include:_spf.google.com include:sendgrid.net include:mailchimp.com -all.`  При проверке этой записи ты обнаруживаешь, что количество DNS-запросов превышает 10.  Проанализировав SPF-записи Google, SendGrid и Mailchimp, ты обнаруживаешь, что каждая из них содержит несколько include.  В этом случае можно попробовать объединить сервисы в одну SPF-запись или использовать механизмы a и mx, если это возможно.  

**Теперь давай перейдем к практическому заданию.** Представь, что ты настроил SPF-запись для домена `example.org: v=spf1 a:mail.example.org include:thirdpartyservice.com -all.`  Ты используешь сервис thirdpartyservice.com для рассылки, но письма попадают в спам.  При проверке SPF-записи ты обнаруживаешь, что количество DNS-запросов равно 12.  Как ты будешь диагностировать и решать эту проблему? 

**Диагностика**:
1. Анализ SPF-записи thirdpartyservice.com:  Основная причина превышения лимита DNS-запросов -  механизм include:thirdpartyservice.com.  Необходимо проверить SPF-запись thirdpartyservice.com  с помощью одного из онлайн-инструментов, упомянутых ранее (MxToolbox, Kitterman, Dmarcian).  Скорее всего, эта запись содержит несколько вложенных include, которые и приводят к превышению лимита.
**Решение**:
2. Оптимизация SPF-записи thirdpartyservice.com (если возможно):  Если у тебя есть доступ к настройкам DNS домена thirdpartyservice.com,  попробуй оптимизировать их SPF-запись, уменьшив количество вложенных include.  Это может потребовать объединения нескольких сервисов в одну SPF-запись или использования механизмов a и mx, если это применимо.  Однако, это решение возможно только если у тебя есть контроль над доменом thirdpartyservice.com.
3. Запрос информации у thirdpartyservice.com:  Свяжись с поддержкой thirdpartyservice.com и сообщи им о проблеме.  Они могут предоставить информацию о том, как оптимизировать SPF-запись для использования их сервиса, или предложить альтернативные методы настройки.  Возможно, они предоставят тебе IP-адреса или диапазоны IP-адресов своих серверов, которые ты сможешь использовать непосредственно в своей SPF-записи с помощью механизма ip4 или ip6.
4. Использование IP-адресов (если предоставлены): Если thirdpartyservice.com предоставит тебе IP-адреса или диапазоны IP-адресов своих серверов,  замени include:thirdpartyservice.com на ip4:<IP-адрес> или ip6:<IP-адрес> в своей SPF-записи.  Например: v=spf1 a:mail.example.org ip4:xxx.xxx.xxx.xxx -all, где xxx.xxx.xxx.xxx - IP-адрес сервера thirdpartyservice.com.
5. Использование механизма a (если применимо): Если thirdpartyservice.com использует для отправки писем домен, для которого настроена A-запись,  ты можешь использовать механизм a вместо include.  Например, если thirdpartyservice.com отправляет письма с сервера mail.thirdpartyservice.com,  ты можешь использовать a:mail.thirdpartyservice.com в своей SPF-записи.
Важно:  После внесения любых изменений в SPF-запись всегда проверяй ее с помощью онлайн-инструментов, чтобы убедиться в ее корректности и в том, что количество DNS-запросов не превышает 10.

**SPF и безопасность.**

SPF  предотвращает подделку адреса отправителя (спуфинг),  усложняя злоумышленникам отправку писем от имени вашего домена.  Это достигается путем проверки IP-адреса отправляющего сервера.  Если IP-адрес не авторизован в SPF-записи домена отправителя,  письмо может быть помечено как спам или заблокировано.  

==Примеры атак и способы защиты:==
1. **Спуфинг адреса отправителя**:  Злоумышленник отправляет письмо, подделывая адрес отправителя,  например,  admin@yourdomain.com.  Без SPF почтовые серверы не могут проверить, действительно ли письмо отправлено с авторизованного сервера. **Защита с помощью SPF**:  SPF-запись позволяет указать, какие серверы имеют право отправлять письма от имени вашего домена.  Если письмо отправлено с неавторизованного сервера,  получающий сервер может отклонить его или пометить как спам.
2. **Фишинговые атаки**:  Злоумышленники часто используют спуфинг адреса отправителя для проведения фишинговых атак.  Они отправляют письма,  которые выглядят как официальные сообщения от известных компаний,  банков или других организаций,  с целью получения конфиденциальной информации (логины, пароли, данные кредитных карт). **Защита с помощью SPF**:  SPF  усложняет злоумышленникам подделку адреса отправителя,  тем самым снижая эффективность фишинговых атак.

**Ограничения SPF**:
Важно понимать, что SPF не является панацеей.  Он не защищает от всех видов атак.  Например,  SPF не может защитить от атак,  при которых злоумышленник использует поддельный домен,  похожий на ваш (например,  yourbank.net вместо yourbank.com).

**Совместное использование SPF с другими методами защиты**:
Для максимальной защиты рекомендуется использовать SPF совместно с другими методами аутентификации электронной почты,  такими как DKIM и DMARC.  Мы рассмотрим эти методы в следующих модулях.

**DMARC: Политики и теги.**
DMARC (Domain-based Message Authentication, Reporting & Conformance) — это система, построенная поверх SPF и DKIM, которая позволяет владельцу домена указать, что делать с письмами, не прошедшими проверку SPF или DKIM. DMARC также предоставляет механизм для получения отчетов о проверках аутентификации.

DMARC-запись публикуется в DNS как TXT-запись для поддомена `_dmarc.` Например, для домена example.com DMARC-запись будет опубликована для` _dmarc.example.com`.

Основные теги DMARC:

 `v=:` Версия DMARC (всегда DMARC1).  Обязательный тег.
  
 `p=:`  Политика DMARC.  Определяет, что делать с письмами, не прошедшими проверку SPF или DKIM.  Обязательный тег.  Возможные значения: `none:` никаких действий не предпринимается.  Письма доставляются как обычно.  Используется для мониторинга. `quarantine:`Письма помещаются в спам. `reject:` Письма отклоняются.

 `rua=:`  Адрес электронной почты для получения агрегированных отчетов.  Необязательный тег.

 `ruf=:`  Адрес электронной почты для получения forensic-отчетов (отчетов о каждом отдельном письме).  Необязательный тег.

 `pct=:`  Процент писем, к которым применяется политика DMARC.  Необязательный тег.  По умолчанию 100%.  Полезно для постепенного ужесточения политики.

 `sp=:`  Политика DMARC для поддоменов.  Необязательный тег.  Наследует значение p= по умолчанию.

 `adkim=:`  Строгое соответствие DKIM (relaxed/strict). Необязательный тег. По умолчанию r.

 `aspf=:`  Строгое соответствие SPF (relaxed/strict). Необязательный тег. По умолчанию r.

  
  

Пример DMARC-записи:
`v=DMARC1; p=none; rua=mailto:dmarc_reports@example.com`
Эта запись указывает, что никакие действия не предпринимаются с письмами, не прошедшими проверку SPF или DKIM, и отправляет агрегированные отчеты на адрес dmarc_reports@example.com.

**Влияние настроек DMARC корневого домена на подключаемые домены через include в SPF:** ==DMARC применяется к домену, указанному в заголовке From письма.==  Если в SPF-записи домена example.com используется include для другого домена (например, `include:_spf.thirdparty.com`),  и письмо отправлено от имени example.com,  то будет проверяться DMARC-запись домена example.com, а не thirdparty.com.

**DMARC-отчеты.**  

DMARC-отчеты предоставляют ценную информацию о том, как обрабатываются ваши письма почтовыми серверами, и помогают выявить проблемы с аутентификацией.  Существует два типа DMARC-отчетов:  

 **Агрегированные отчеты (RUA):**  Отправляются ежедневно и содержат обобщенную информацию о проверках аутентификации за прошедший период.  Они предоставляют статистику по доменам, отправляющим письма от вашего имени,  и показывают, сколько писем прошло и не прошло проверку SPF и DKIM. [[Пример отчета RUA]]

**Forensic-отчеты (RUF):**  Отправляются для каждого отдельного письма, не прошедшего проверку DMARC.  Они содержат подробную информацию о заголовках письма и причинах, по которым оно не прошло проверку. [[Пример отчета RUF]]
  
Если письма с определенного IP не проходят проверку:
1. Определение владельца IP-адреса: Используй сервисы whois lookup (например, whois <IP-адрес> в командной строке или онлайн-сервисы типа whois.net), чтобы узнать, кому принадлежит IP-адрес. Это поможет понять, какой сервер или сервис отправляет письма.
2. Проверка заголовка From:  В отчете RUA обычно указывается заголовок From, который использовался в письмах.  Это подтвердит, от имени какого домена отправлялись письма.  Убедись, что этот домен соответствует твоим ожиданиям.
3. Проверка SPF-записи отправляющего домена:  После того, как ты определил домен, от имени которого отправлялись письма,  проверь его SPF-запись с помощью онлайн-инструментов,  упомянутых ранее (MxToolbox, Kitterman, Dmarcian).  Обрати внимание на следующие моменты:
   -  Наличие SPF-записи: Убедись, что SPF-запись вообще существует для этого домена.
   - Корректность SPF-записи: Проверь, правильно ли настроена SPF-запись.  Включены ли все необходимые IP-адреса и/или include механизмы?  Нет ли превышения лимита DNS-запросов?
   - Соответствие IP-адреса:  Убедись, что IP-адрес,  с которого отправлялись письма,  авторизован в SPF-записи домена.

 Дополнительные действия: 
 - Связь с владельцем IP-адреса/сервиса:  Если IP-адрес принадлежит стороннему сервису,  свяжись с их поддержкой и сообщи о проблеме.  Возможно, им потребуется обновить свою SPF-запись.
 - Проверка логов почтового сервера:  Если IP-адрес принадлежит твоему серверу,  проверь логи почтового сервера на наличие ошибок или подозрительной активности.

**DMARC и совместимость с SPF и DKIM.**

DMARC, SPF и DKIM работают вместе для обеспечения максимальной защиты электронной почты.  DMARC полагается на результаты проверки SPF и DKIM для принятия решения о том, что делать с письмом.  Важно понимать, как эти механизмы взаимодействуют друг с другом.

Совместная работа DMARC, SPF и DKIM:
1. SPF:  Проверяет, авторизован ли IP-адрес отправляющего сервера отправлять письма от имени домена, указанного в заголовке Return-Path (часто совпадает с From, но не всегда).
2. DKIM:  Проверяет, было ли письмо изменено после отправки, и подтверждает, что оно действительно отправлено от имени домена, указанного в подписи DKIM.  DKIM подписывает заголовки и/или тело письма с помощью приватного ключа, а получатель проверяет подпись с помощью публичного ключа, опубликованного в DNS.
3. DMARC:  Использует результаты проверки SPF и DKIM для определения, соответствует ли письмо политике DMARC.  DMARC проверяет выравнивание (alignment)

**Выравнивание записей**

==Выравнивание SPF (SPF Alignment)==:  Домен в заголовке Return-Path должен соответствовать
домену,  использованному при проверке SPF.  Существует два типа выравнивания SPF:  strict (строгое) и relaxed (мягкое).  При строгом выравнивании домены должны полностью совпадать.  При мягком выравнивании достаточно совпадения организационной части домена (например,  example.com и mail.example.com).

==Выравнивание DKIM (DKIM Alignment):==  Домен в подписи DKIM (d=) должен соответствовать домену,  указанному в заголовке From.  Также существует два типа выравнивания DKIM:  strict (строгое) и relaxed (мягкое).  Правила совпадения доменов аналогичны выравниванию SPF.

Примеры:
- Успешная аутентификация:  Письмо отправлено с авторизованного сервера (SPF прошел),  подписано с помощью DKIM,  и выравнивание SPF и DKIM выполнено.  DMARC также пройдет, и письмо будет доставлено.
- Неудачная аутентификация:  Письмо отправлено с неавторизованного сервера (SPF не прошел),  или подпись DKIM недействительна,  или выравнивание SPF/DKIM не выполнено.  В этом случае DMARC не пройдет, и к письму будет применена политика DMARC (none, quarantine, reject). 

**Важность выравнивания**

Выравнивание SPF и DKIM  - критически важный аспект DMARC.  Без правильного выравнивания  DMARC может не пройти,  даже если SPF и DKIM пройдены.  Это связано с тем, что злоумышленники могут использовать поддельные домены,  которые проходят SPF и DKIM,  но не соответствуют домену в заголовке From.

Практический пример:
Домен example.org имеет DMARC-запись v=DMARC1; p=reject; adkim=s; aspf=s.  Письмо отправлено от имени info@example.org.  SPF прошел для домена thirdparty.com (из-за include механизма).  DKIM прошел, и подпись DKIM содержит d=example.net.  Пройдет ли DMARC проверку?  Почему?

DMARC проверку не пройдет:
1. Несмотря на то, что SPF и DKIM пройдены,  DMARC требует строгого выравнивания (adkim=s; aspf=s).
2.  SPF Alignment:  SPF прошел для thirdparty.com,  но заголовок From содержит example.org.  Строгое выравнивание SPF требует полного совпадения доменов,  поэтому SPF alignment не пройден.
3. DKIM Alignment:  DKIM прошел,  но подпись DKIM содержит d=example.net,  а заголовок From содержит example.org.  Строгое выравнивание DKIM также требует полного совпадения доменов,  поэтому DKIM alignment не пройден.
В результате,  хотя SPF и DKIM пройдены,  DMARC не пройден из-за невыполненного строгого выравнивания.  К письму будет применена политика p=reject,  и оно будет отклонено. Этот пример показывает важность правильной настройки выравнивания SPF и DKIM.  Даже если SPF и DKIM настроены корректно,  неправильное выравнивание может привести к отклонению писем.

**DKIM: Принципы работы и создание подписи.**

DKIM (DomainKeys Identified Mail) — это метод аутентификации электронной почты, который позволяет владельцу домена добавить цифровую подпись к исходящим письмам.  Эта подпись подтверждает, что письмо действительно отправлено от имени указанного домена и не было изменено в процессе доставки.

Принципы работы DKIM:
1. Генерация ключей:  Для использования DKIM необходимо сгенерировать пару ключей:  приватный и публичный.  Приватный ключ используется для подписи писем,  а публичный ключ публикуется в DNS.
2. Подпись письма:  При отправке письма почтовый сервер использует приватный ключ для создания цифровой подписи,  которая добавляется к заголовкам письма.  Подпись включает в себя селектор,  который указывает, где найти публичный ключ в DNS.
3. Проверка подписи:  Получающий сервер извлекает публичный ключ из DNS,  используя селектор из подписи.  Затем он проверяет подпись,  сравнивая ее с содержимым письма.  Если подпись действительна и письмо не было изменено,  проверка DKIM считается пройденной.

Создание подписи DKIM:

Для создания подписи DKIM необходимо сгенерировать пару ключей (приватный и публичный).  Это можно сделать с помощью различных инструментов,  включая:
 - OpenSSL:  Универсальный инструмент командной строки для работы с криптографией.
 - Онлайн-генераторы ключей:  Существуют различные онлайн-сервисы,  которые позволяют сгенерировать ключи DKIM.

  

Публикация публичного ключа:

Публичный ключ публикуется в DNS как TXT-запись для поддомена selector.domainkey.yourdomain.com,  где selector -  выбранный вами селектор.

Пример DKIM-записи:
`selector._domainkey.example.com.  TXT  "v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC..."`

 `v=DKIM1:` Версия DKIM.
`k=rsa:` Тип ключа (обычно rsa).
`p=:`  Публичный ключ.

**Публикация публичного ключа в DNS:**

После того, как ты получил публичный ключ,  его нужно опубликовать в DNS как TXT-запись.  Для этого тебе нужно:
1. Выбрать селектор:  Селектор - это произвольное имя,  которое используется для идентификации DKIM-записи.  Например,  default или 2023.
2. Создать TXT-запись:  Создай TXT-запись для поддомена selector.domainkey.example.net,  где selector -  выбранный тобой селектор.  Значение TXT-записи должно быть следующим: `v=DKIM1; k=rsa; p=<публичный ключ>`

После публикации TXT-записи  DKIM будет настроен для твоего домена.

**DKIM: Выбор селектора и типа ключа.**

Селектор — это произвольное имя, которое используется для идентификации DKIM-записи в DNS.  Выбор селектора влияет на то, как получающие серверы будут искать публичный ключ DKIM.

Рекомендации по выбору селектора:
- Используй понятные и простые имена, например, default, 2023 (год), или key1.
- Избегай использования специальных символов.
- Селектор не должен совпадать с другими именами в твоей DNS-зоне.

Рекомендуется периодически ротировать ключи DKIM для повышения безопасности.  Использование разных селекторов упрощает ротацию ключей,  позволяя публиковать новый ключ с новым селектором,  не затрагивая существующую настройку.

Наиболее распространенный тип ключа.  RSA -  широко используемый асимметричный алгоритм шифрования. Существуют и другие типы ключей,  например,  ed25519,  но они менее распространены и могут не поддерживаться всеми почтовыми серверами.  Длина ключа RSA влияет на безопасность DKIM.  Рекомендуется использовать ключи длиной не менее 1024 бит,  а лучше 2048 бит или больше.

**DKIM и безопасность.**

DKIM усложняет злоумышленникам подделку писем, так как для создания действительной подписи DKIM требуется доступ к приватному ключу.  Обеспечение целостности сообщений: DKIM гарантирует, что письмо не было изменено после отправки. Если письмо было изменено, подпись DKIM станет недействительной, и получающий сервер сможет обнаружить это.  

Примеры атак и способы защиты: 
1. **Подмена содержимого письма**: Злоумышленник может перехватить письмо и изменить его содержимое, например, заменить ссылку на фишинговый сайт. **Защита с помощью DKIM**: DKIM подписывает заголовки и/или тело письма. Если содержимое письма изменено, подпись DKIM станет недействительной, и получающий сервер обнаружит подмену. 
2. **Подделка заголовков письма**: Злоумышленник может изменить заголовки письма, например, добавить или удалить заголовки Received, чтобы скрыть источник письма. **Защита с помощью DKIM**: DKIM подписывает заголовки письма, включая From.  Изменение заголовков приведет к недействительности подписи DKIM.

  Ограничения DKIM:
  - Не защищает от подделки домена отправителя: DKIM проверяет только, что письмо отправлено от имени домена, указанного в подписи DKIM.  Он не проверяет, является ли этот домен легитимным.  Злоумышленник может использовать поддельный домен, похожий на настоящий, и настроить для него DKIM.
  - Не гарантирует доставку письма:  Даже если DKIM пройден, письмо может быть помечено как спам или заблокировано по другим причинам, например, из-за низкой репутации отправляющего IP-адреса.

Для максимальной защиты рекомендуется использовать DKIM совместно с SPF и DMARC.  Вместе эти механизмы обеспечивают комплексную защиту от различных видов атак.

Практический пример: 
Злоумышленник перехватил письмо, отправленное с вашего домена example.com, и заменил ссылку в теле письма на фишинговый сайт.  Как DKIM поможет защитить получателя от этой атаки?
Если для домена example.com настроен DKIM, и подпись DKIM покрывает тело письма (что является рекомендуемой практикой), то при изменении ссылки в теле письма подпись DKIM станет недействительной.  Когда получающий сервер проверит подпись DKIM, он обнаружит несоответствие между подписанным содержимым и фактическим содержимым письма.  Это будет сигналом о том, что письмо было изменено после отправки, и получающий сервер сможет принять соответствующие меры, например, пометить письмо как спам или заблокировать его.  Таким образом, DKIM защитит получателя от фишинговой атаки.

**Настройка SPF, DMARC и DKIM для различных почтовых систем.**

Большинство популярных почтовых сервисов (Google Workspace, Яндекс.Почта, Mail.ru для бизнеса и др.) предоставляют подробные инструкции по настройке SPF, DMARC и DKIM.  Обычно это сводится к добавлению определенных DNS-записей, предоставленных сервисом.


Настройка для собственных почтовых серверов требует более глубоких технических знаний.  Вам нужно будет самостоятельно сгенерировать ключи DKIM, настроить почтовый сервер для подписи исходящих писем и опубликовать публичный ключ DKIM в DNS.  SPF-запись должна включать IP-адреса ваших почтовых серверов.  DMARC настраивается аналогично, как и для почтовых сервисов.

Настройка include для поддоменов и сторонних сервисов:
Поддомены:  Если вы используете поддомены для отправки почты, убедитесь, что SPF-запись для каждого поддомена включает необходимые механизмы include или ip4/ip6.  Также настройте DMARC для каждого поддомена, учитывая политику корневого домена.

Сторонние сервисы:  Если вы используете сторонние сервисы для рассылки,  включите их SPF-записи в свою SPF-запись с помощью механизма include.  Убедитесь, что количество DNS-запросов не превышает 10.  Обратите внимание на выравнивание SPF и DKIM при настройке DMARC.

Практический пример:
Вы используете Google Workspace для основного домена example.com и SendGrid для рассылки с поддомена news.example.com.  Как вы настроите SPF, DMARC и DKIM в этом случае?

Для домена example.com (Google Workspace):
- SPF: `v=spf1 include:_spf.google.com -all`
- DKIM: Следуйте инструкциям Google Workspace для настройки DKIM.  Google предоставит вам TXT-запись для публикации в DNS.
- DMARC:  `v=DMARC1; p=none; rua=mailto:dmarc_reports@example.com` (начните с p=none для мониторинга).

Для поддомена news.example.com (SendGrid):
- SPF: `v=spf1 include:sendgrid.net -all` (используйте SPF-запись, предоставленную SendGrid)
- DKIM:  Следуйте инструкциям SendGrid для настройки DKIM.  SendGrid предоставит вам TXT-запись для публикации в DNS. 
- DMARC:  `v=DMARC1; p=none; rua=mailto:dmarc_reports@example.com` (начните с p=none для мониторинга,  можно использовать тот же адрес для отчетов, что и для основного домена).

Важные моменты:
- Отдельные записи для поддомена:  Обратите внимание, что для поддомена news.example.com создаются отдельные SPF, DKIM и DMARC записи.  Они не наследуются от основного домена.
- Мониторинг и ужесточение политики DMARC:  После начальной настройки с p=none  мониторьте DMARC-отчеты и постепенно ужесточайте политику до p=quarantine и затем до p=reject.
- Выравнивание:  Убедитесь, что выравнивание SPF и DKIM настроено корректно для обоих доменов.
