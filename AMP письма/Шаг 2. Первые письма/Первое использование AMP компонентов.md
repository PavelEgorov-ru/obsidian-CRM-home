Я делю AMP письма на три больших группы, которые могут быть как самостоятельными, так и включать в себя другие группы.

1. Письма с использованием компонентов, которые отображают контент по новому. В них есть базовая интерактивность. Сюда относятся применение каруселей, сайд-бара и тд.
2. Письма, где логику отображения контента программирует создатель письма. Используется компонент управления внутренним стейтом письма: контент может менять свой вид, появляться или исчезать в зависимости от действий пользователя.
3. Письма, которые получают и отправляют информацию на сервер. Самое простое - подтверждение подписки. Пользователь нажал кнопку, письмо отправило данные на сервер, получило ответ, который можно использовать для отображения успеха подтверждения.  Это "качественный скачок" в создании AMP писем. Здесь требуется не только сделать само письмо, но и развернуть, поддерживать и защищать серверную часть. Здесь появляются требования к CORS, проверка заголовков `AMP-Email-Sender`, защита от атак. 

На самом деле в этой классификации далеко не все так однозначно, но для старта я пока оставлю именно это разделение. К нему мы будем возвращаться ни один раз.

При создании писем эти группы можно и, самое главное, нужно комбинировать между собой.

Начнем создание письма используя стартовую [заготовку](https://github.com/PavelEgorov-ru/obsidian-CRM-home/blob/main/Примеры%20писем/ШАГ%201%20стартовый%20шаблон%20письма.html)

Для удобства разработки писем рекомендую использовать в теге head следующую строку:
`<meta name="viewport" content="width=device-width, initial-scale=1.0">` Она нужна для того, чтобы можно было проверять поведение письма при изменении разрешения экрана. Эта строчка не валидная с точки зрения валидатора AMP. Поэтому перед тестированием писем в песочнице эту строчку нужно закомментировать.

[ПРИМЕР ПИСЬМА](https://github.com/PavelEgorov-ru/obsidian-CRM-home/blob/main/Примеры%20писем/ШАГ%202%20Пример%20использования%20слайдера.html) с компонентами, описанными здесь.

## amp-img

В любом письме почти наверняка используются изображения. Обычный тег для изображений `img` запрещен в AMP письмах. Вместо него следует использовать тег `amp-img`.

Обязательные атрибуты:
- `src`
- `width`
- `height`

Разрешенные атрибуты:
- `alt`

Есть еще несколько разрешенных атрибутов, но я намеренно не указываю их здесь. Они появятся в нужный момент в будущем.

В теге `amp-img` запрещено использовать часть атрибутов обычного тега `img`:
- `style` - есть значительные ограничения в использовании. В amp тегах можно указывать CSS стили `width` и  `height`, но только в том случае, если `layout="fixed"`  Размер стилей в атрибуте не должен превышать 1000 байт. Этот размер учитывается в общем лимите на размер указанных стилей в 75Kb. В целом, я не вижу смысла использовать инлайновые стили в AMP письмах
- атрибуты обработчиков событий  `onclick`,  `onmouseover` 
- атрибут ленивой загрузки `loading="lazy"` . `amp-img` - делает это по умолчанию.
- адаптивные атрибуты  `srcset`,  `sizes`
- устаревшие атрибуты форматирования `align`, `border`, `hspace`, `vspace` 

Вместо адаптивных атрибутов в AMP элементах используется атрибут `layout` О нем поговорим позже.

В целом использование компонента максимально простое. В основных кейсах это такой же тег `img` , без устаревших атрибутов и атрибутов, не используемых в email верстке.

Пример использования

```
<amp-img class="banner" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="responsive" width="600" height="400" alt="Новогодний набор БУКВА-ЛЕНД">
</amp-img>
```

## Первая важная особенность в вёрстке AMP писем.

Одной из главных оптимизаций в AMP является предотвращение скачков контента. Для этого перед рендером html разметки движок браузера или почтовика должен знать все размеры элементов:
- размеры основных блочных и инлайновых тегов вычисляются в соответствии с встроенными и костюмными стилями.
- размеры элементов с "внешним источником" нужно указывать заранее. Поэтому для компонента `amp-img` атрибуты размера элемента обязательны.

## Вторая важная особенность в вёрстке AMP писем. Layout. Первое знакомство на примере изображений.

Всем AMP компонентам лучше явно указывать то, как он будет себя вести при различных разрешениях экрана. Адаптивность.

Демонстрацию элементов с разными параметрами атрибута `layout` можно посмотреть на [странице документации](https://amp.dev/documentation/guides-and-tutorials/learn/amp-html-layout/layouts_demonstrated#fill).

#### fill
Элемент заполняет все доступное пространство родителя. В этом случае `width` и `height` у элемента игнорируются. Размеры, которые нужно зарезервировать, берутся у родителя. Поэтому их важно указать. Еще одним требованием является свойство родителя `position`. Оно должно быть либо `relative`, либо `absolute`. У дочернего компонента AMP, при `layout="fill"`, значение `position` по умолчанию `absolute`. Остальным дочерним элементам это свойство нужно указывать явно.

```

без указания размеров и позиционирования у родителя section class="content", amp-img займет все доступное пространство начиная с body. В данном случае body первый элемент-обертака amp-img, у которого указан position: relative
 

<div class="content-fill">
	<amp-img class="banner" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="fill" alt="Новогодний набор БУКВА-ЛЕНД"></amp-img>
	<p class="text">Разные примеры использования атрибута layout</p>
</div>
```


```
сделаем section class="content-fill" первым родителем, кого указан position. Теперь amp-img с layout="fill" имеет свойство position: absolute по умолчанию, он берет размеры родителя 400 на 500 px и занимает это пространство. 

p class="text-fill" остается невидимым, т.к. у него position не указан явно

.content-fill {
	position: relative;
	width: 400px;
	height: 500px;
}

<div class="content-fill">
	<amp-img class="banner-fill" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="fill" alt="Новогодний набор БУКВА-ЛЕНД"></amp-img>
	<p class="text-fill">amp-img занял размеры первого родителя, у кого указано свойтсво position </p>
	<p class="text-fill">Т.к у текста еще не указано свойсвто position, он не будет виден </p>
</div>
```

```
Указываем p class="text-fill" position явно

.content-fill {
	position: relative;
	width: 400px;
	height: 500px;
}

.text-fill {
	position: relative;
}

<div class="content-fill">
	<amp-img class="banner-fill" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="fill" alt="Новогодний набор БУКВА-ЛЕНД"></amp-img>
	<p class="text-fill">теперь этот текст виден </p>
	<p class="text-fill">Ураааа!! </p>
</div>
```

Более подробно в доступной форме про работу с позиционированием можно посмотреть в [Доке](https://doka.guide/css/position/).


#### fixed

Элемент имеет фиксированные неизменяемы размеры. В принципе все достаточно просто. Раз элемент имеет фиксированные значения, значит для него становятся обязательными атрибуты `width` и `height` 

```
<div>
	<amp-img class="banner-fixed" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="fixed" width="600" height="200" alt="Новогодний набор БУКВА-ЛЕНД"></amp-img>
</div>
```

При изменении разрешения, если элемент c `layout="fixed"` имеет фиксированную ширину больше ширины экрана, письмо становится некрасивым). Его распирает. Вы это видели часто, если верстали письма.

#### fixed-height

Элемент имеет фиксированную высоту (заданную атрибутом `height`), а его ширина автоматически подстраивается под ширину родительского контейнера. Хоть ширина и подстраивается автоматически, лучше это указывать явно: `width="auto"`

```
<div>
	<amp-img class="banner-fixed-height" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="fixed-height" width="auto" height="200" alt="Новогодний набор БУКВА-ЛЕНД"></amp-img>
</div>
```

#### intrinsic

Очень похожее поведение на `layout="responsive"`. Элемент масштабируется до тех пор, пока не достигнет своих "естественных" размеров (заданных `width` и `height`). После этого он перестает увеличиваться и центрируется внутри родительского контейнера.
Важно понимать, что про адаптивность можно думать не только в направлении "из большого экрана в маленький", но и наоборот "из маленького экрана на большой". 

Например, я хочу иметь изображение на всю ширину экрана 320px в мобилке, но на десктопе я хочу иметь размер на более 450px в ширину.

```
<div>
	<amp-img class="banner-fixed-height" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="intrinsic" width="450" height="200" alt="Новогодний набор БУКВА-ЛЕНД"></amp-img>
</div>
```

#### responsive

В большинстве случаев для изображений будет использоваться он. Элемент занимает всю доступную ширину родительского контейнера и автоматически подбирает высоту, чтобы сохранить пропорции, заданные атрибутами `width` и `height`. Если хочется чтобы изображение было на всю ширину и, сохраняя пропорции, подстраивалось под ширину экрана, то нужно использовать именно этот layout.

```
Пример, как работает layout="responsive". Ширина изображения 1200px, высота - 600px. соотношение 2:1. Ширина контейнера - 50% от своего родителя. Какой бы ширины он ни был, amp-img будет сохранять свои пропорции 2:1

.content-responsive {
	max-width: 50%;
}

<div class="content-responsive">
	<amp-img class="banner-responsive" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="responsive" width="1200" height="600" alt="Новогодний набор БУКВА-ЛЕНД">
	</amp-img>
</div>
```

Есть еще один хитрый layout, который поддерживается в компоненте `amp-img`

#### flex-item

Давайте представим стандартную ситуацию. У вас есть `<amp-img layout="responsive">`. AMP ожидает, что сможет рассчитать его размер, взяв ширину родительского блока.

Теперь представим CSS Flexbox. Flexbox-контейнер (`display: flex`) сам управляет размерами своих дочерних элементов, используя свойства `flex-grow`, `flex-shrink` и `flex-basis`.

**Возникает конфликт:**
- **AMP Layout System:** "Я сам решу, какого размера будет этот `amp-img`!"
- **CSS Flexbox Layout System:** "Нет, я решаю, какого размера будут мои дочерние элементы!"

Атрибут `layout="flex-item"` — это способ сказать AMP-системе: **"Отступи. Позволь Flexbox-контейнеру управлять моим размером"**.

Когда вы используете `layout="flex-item"`, AMP-компонент:
1. **Передает контроль:** Он перестает навязывать свой собственный размер.
2. **Подчиняется Flexbox:** Его размер будет определяться CSS-свойствами `flex`, `align-self` и другими правилами родительского flex-контейнера.
3. **Сохраняет AMP-магию:** При этом он все еще остается AMP-компонентом, то есть AMP-рантайм продолжает управлять его жизненным циклом (например, ленивой загрузкой для `amp-img`).

Если несколько `amp-img` используются в flex-контейнере, то каждому из них нужно дать `layout="flex-item"`

Все разобранные примеры можно посмотреть по [этой ссылке](https://github.com/PavelEgorov-ru/amp-email-1/blob/1/amp-email-1.html).

До текущего момента нам для использования AMP компонента не требовалось ничего, кроме использования тега сразу в верстке. `amp-img` - единственный компонент, который можно так использовать. Для остальных нужно подключать специальные скрипты в тег `head`. Письмо, в котором есть скрипты неиспользуемых компонентов, не пройдет валидацию.

## amp-anim

документация - https://amp.dev/documentation/examples/email/components/amp-anim.email/
компонент - https://amp.dev/documentation/components/email/amp-anim

Подключение - 
`<script async custom-element="amp-anim"  src="https://cdn.ampproject.org/v0/amp-anim-0.1.js"></script>` 

В обычном веб- и email-весртке для изображения используется один тег - `img`. Он может работать как со статическим изображением (.png, .img и т.д.), так и с gif. В AMP-верстке это не так. Для работы гиф в письме требуется отдельный компонент - `amp-anim`.

Главная причина появления этого AMP компонента - оптимизация. Вообще, все AMP компоненты нужны либо для оптимизации, либо для безопасности.

В обычном браузере, гифка загружается через тег `img` и начинает непрерывно проигрываться. Браузер тратить ресурсы устройства, устройство быстрее тратит свою энергию. 

`amp-anim` проигрывает гифку только тогда, когда она находится во вьюпорте. Т.е. анимация проигрывается только тогда, когда пользователь видит ее на экране устройства.

Можно использовать в двух вариантах

```
Первый вариант. Если гифка не загрузится, какое-то время будет показываться лоадер загрузки, потом - текст из атрибута alt

<div>
	<amp-anim width="900" height="197" src="https://trafaret-decor.art/sites/default/files/animatepeoples/kids/funny%20(6).gf" alt="гифка"         layout="responsive">
	</amp-anim>
</div>
```

Гиф-анимация часто бывает тяжелой и не может сразу загрузиться на устройство. Пока она полностью не загрузится, можно показывать статическое изображение.

```
Второй вариант. Внутрь помещают amp-img и добавляют к нему атрибут placeholder.

Чтобы не было скачков контента при переключении отображения с amp-img на amp-anim, нужно указывать им одинаковые атрибуты ширины, высоты и layout

<div>
	<amp-anim width="900" height="197" src="https://trafaret-decor.art/sites/default/files/animatepeoples/kids/funny%20(6).gf" alt="гифка"         layout="responsive">
		<amp-img placeholder width="900" height="197" src="https://rassylka.static1-sima-land.com/ftp_rassylka/000032743-1/0000.png" layout="responsive">
		</amp-img>
	</amp-anim>
</div>
```

Не рекомендуется использовать много анимации, особенно тяжелой. Нужно не забывать оптимизировать и сжимать каждую гифку.

В целом, про этот компонент мне больше нечего сказать.

## amp-carousel

документация - https://amp.dev/documentation/examples/email/components/amp-carousel.email/
компонент - https://amp.dev/documentation/components/email/amp-carousel

Подключение - 
`<script async custom-element="amp-carousel" src="https://cdn.ampproject.org/v0/amp-carousel-0.1.js"></script>`

`amp-carousel` — это компонент, который позволяет создавать прокручиваемые галереи контента (слайдеры) прямо внутри письма.

Для чего может использоваться, особенно в email-письмах:
- Экономия места. Можно упаковать в компактный блок большой объем информации. Для ее просмотра не нужно скролить вниз письма.
- Письмо становится больше похоже на веб страницу

Как и все (большинство?) AMP-компонентов, `amp-carousel` требует указания атрибутов - `width` и  `height` для резервирования пространства во время рендера письма.

#### Два вида amp-carousel

##### `type="carousel"`

"Ленточная" карусель. Она отображает **несколько элементов одновременно** в виде непрерывной горизонтальной полосы. Прокрутка плавная, без "привязки" к конкретному элементу.

Особенности:
- Плавная прокрутка. Пользователь может остановить прокрутку в любом месте, даже между двумя элементами
- Можно самостоятельно определить ширину каждого элемента внутри карусели с помощью CSS. Они не растягиваются на всю ширину карусели.
- По умолчанию у этого типа нет встроенной навигации. Взаимодействие происходит через свайп (на мобильных) или мышью/тачпадом на десктопе.

Основная задача - просмотр большого количества однотипных элементов.

Как можно использовать в email-письмах:
1. Рекомендации товаров. Пользователь может быстро просмотреть десятки вариантов в компактном блоке без скрола, не покидая письмо.
2. Подборка статей или новостей. Что-то типа блока "Читайте также".
3. Горизонтальное меню категорий интернет-магазина
4. Галерея фото в карточке товара
5. Галерея логотипов спонсоров какого-нибудь оффлайн или онлайн события

**Поддерживаемые `layout`.** 
- `fixed` - и лента, и ее содержимое будут иметь фиксированные размеры. Прокрутка будет работать внутри этого фиксированного блока. Редко используется. Для ленты это нелогично. **`width` и `height`: Обязательны**.
- ==`responsive` - контейнер карусели будет адаптивным, но внутри него все равно будет горизонтальная прокрутка. **`width` и `height`: Обязательны**. Это может быть полезно, если нужно, чтобы высота ленты менялась в зависимости от ширины экрана, сохраняя пропорции. Но чаще всего для ленты нужна именно фиксированная высота.==
- `fixed-height` - самый часто используемый вариант. Задается фиксированную высота для "ленты", а она может бесконечно скролиться по горизонтали. **`width` и `height`: Обязательны**. Для атрибута `width` установить `auto`.

**Layout элементов карусели:**
- `layout="responsive"` и `layout="fill"` - **запрещены**. Эти layout заставили бы каждый элемент попытаться занять 100% ширины контейнера карусели, что полностью сломает идею "ленты". Вы получите один элемент на всю ширину, а остальные будут скрыты. AMP-валидатор выдаст ошибку.
- `fixed` - все элементы имеют фиксированную ширину и высоту (заранее известные размеры). Не применять если карусель имеет `layout="responsive"`
```
<amp-carousel type="carousel" layout="fixed-height" height="150" width="auto">
  <!-- Карточки товаров фиксированного размера -->
  <amp-img src="..." layout="fixed" width="100" height="150"></amp-img>
  <amp-img src="..." layout="fixed" width="100" height="150"></amp-img>
</amp-carousel>
```
- `flex-item` , `intrinsic` - эти два layout я в каруселях не использовал, пока не представляю, в каких кейсах он может подойти.
##### `type="slides"`

Слайдер. Он отображает **один элемент за раз**, который занимает всю площадь карусели.
С текущего элемента можно перейти на следующий или предыдущий элемент.

Особенности:
- Пошаговая прокрутка. Нельзя остановиться между слайдами.
- Встроенное управление. Можно добавить кнопки навигации (атрибут `controls`) и зацикливание (при переключении с последнего элемента на следующий, показывается первый элемент из списка. Управляется атрибутом `loop`)
- Автопроигрывание. Его можно включить с помощью атрибута `autoplay`. С помощью атрибута `delay` можно указать задержку переключения. По умолчанию 5000 мс. Минимальное значение - 1000 мс.

Как можно использовать в email-письмах:
1. Главный рекламный баннер. В шапке письма размещается слайдер с 2-3 основными акциями
2. Обзор в карточке одного товара с разных ракурсов.
3. Пошаговая инструкция или онбординг: шаг 1, шаг 2 и т.д.
4. Отзывы клиентов. Один слайд - один отзыв

**Поддерживаемые `layout`.** 
-  `responsive` - контейнер карусели занимает 100% ширины родительского элемента, а его высота подбирается для сохранения пропорций, заданных `width` и `height`. **`width` и `height`: Обязательны**.
- `fixed`- контейнер карусели имеет строго фиксированные размеры, заданные `width` и `height`. **`width` и `height`: Обязательны**. Можно использовать для неадаптивных баннеров или виджетов точного размера.
- `fixed-height` - контейнер карусели имеет фиксированную высоту, а ширина подстраивается под родительский контейнер. **`width` и `height`: Обязательны**. Для атрибута `width` установить `auto`.
- `fill`- контейнер карусели заполняет все пространство родительского контейнера (у которого должно быть `position: relative` или подобное). **`width` и `height`:** **НЕ НУЖНЫ**. Возможно применение в редких случаях, когда карусель является частью другой сложной компоновки.

**Layout элементов слайдера:**
- `fill`- самый частый вариант. Этот layout приказывает элементу (например, `<amp-img>`) растянуться и полностью заполнить своего родителя. Так как родитель — это слайд, который имеет размеры контейнера карусели, изображение идеально вписывается в слайдер.
```
<amp-carousel type="slides" layout="responsive" width="16" height="9">
  <!-- Этот amp-img занимает всё пространство слайда -->
  <amp-img src="..." layout="fill"></amp-img> 
</amp-carousel>
```
- `responsive` - технически будет работать, так как `layout="responsive"` заставляет элемент занять 100% ширины родителя (слайда), что дает тот же эффект, что и `fill`. Но `fill` более семантически корректен в данном контексте, так как он управляет и высотой, и шириной.
- `fixed`, `intrinsic`, `fixed-height` - их можно использовать, если нужно, чтобы контент **не занимал** весь слайд, а был, например, отцентрирован внутри него. В этом случае прямым потомком карусели должен быть `<div>`, а уже внутри него — элемент с нужным layout. Так тоже пока ни разу не делал, это мое предположение
```
<style amp-custom>
  .slide-wrapper { display: flex; align-items: center; justify-content: center; }
</style>
<amp-carousel type="slides" layout="responsive" width="16" height="9">
  <div class="slide-wrapper">
     <amp-img src="icon.svg" layout="fixed" width="50" height="50"></amp-img>
  </div>
</amp-carousel>
```

#### Стилизация amp-carousel

Саму карусель можно стилизовать двумя способами:
- использовать селекторы класса или id
- использовать селектор тега `amp-carousel`

Элементы карусели аналогично:
- использовать селекторы классов или id
- использовать селекторы тегов из которых состоят элементы карусели или класс `.amp-carousel-slide`

Управление кнопками слайдера:
- `.amp-carousel-button-next ` 
- `.amp-carousel-button-prev`
- `.amp-carousel-button[disabled]`