#### **1. Введение**

Этот документ описывает обязательные правила и требования к верстке интерактивных писем с использованием технологии AMP for Email. Соблюдение этих правил гарантирует, что наши письма будут корректно отображаться и функционировать в почтовых клиентах, поддерживающих AMP (Gmail, Mail.ru и др.). Отклонение от этих правил приведет к тому, что письмо будет показано в виде статической HTML-версии.

#### **2. Базовая структура документа (Boilerplate)**

Любое AMP-письмо **обязано** иметь следующую структуру. Используйте этот код как шаблон для всех новых писем.

```
<!doctype html>
<html ⚡4email>
<head>
  <meta charset="utf-8">
  <!-- 1. Загрузка основной библиотеки AMP -->
  <script async src="https://cdn.ampproject.org/v0.js"></script>
  
  <!-- 2. Скрипты для используемых AMP-компонентов (примеры) -->
  <script async custom-element="amp-list" src="https://cdn.ampproject.org/v0/amp-list-0.1.js"></script>
  <script async custom-element="amp-form" src="https://cdn.ampproject.org/v0/amp-form-0.1.js"></script>
  <script async custom-element="amp-mustache" src="https://cdn.ampproject.org/v0/amp-mustache-0.2.js"></script>

  <!-- 3. Обязательный стиль, скрывающий контент до полной загрузки AMP -->
  <style amp4email-boilerplate>body{visibility:hidden}</style>

  <!-- 4. Все кастомные CSS-стили помещаются сюда -->
  <style amp-custom>
    /* 
      - Общий размер CSS не должен превышать 75 КБ.
      - Правила вроде @import, * (универсальный селектор) запрещены.
    */
    body {
      font-family: Helvetica, Arial, sans-serif;
    }
  </style>
</head>
<body>
  <!-- Здесь размещается контент письма -->
  Привет, мир AMP!
</body>
</html>
```

#### **3. Глобальные правила валидации**

Эти правила применяются ко всему документу.

1. **HTTPS Everywhere**: Все внешние ресурсы — изображения, шрифты, скрипты, API-эндпоинты (для форм и `amp-list`) — должны загружаться исключительно по протоколу `https://`.
2. **Ограничения CSS**:
    - Все стили должны находиться внутри единственного тега `<style amp-custom>`.
    - Общий объем стилей не должен превышать **75 КБ**.
    - **Запрещено** использовать: `@import`, `@charset`, универсальный селектор (`*`), псевдоклассы `:link` и `:visited`, а также другие правила, влияющие на производительность. Использование `!important` разрешено, но не рекомендуется.
3. **Запрет на JavaScript**: Использование любых тегов `<script>`, кроме тех, что загружают библиотеки с `cdn.ampproject.org`, строго запрещено. Запрещены все встроенные обработчики событий (`onclick`, `onmouseover` и т.д.). Для интерактивности используются AMP-действия (`on="tap:..."`).
4. **Доступность (Accessibility)**: Для всех изображений, несущих смысловую нагрузку (`<amp-img>`), **обязательно** указывайте осмысленный атрибут `alt`. Для декоративных изображений используйте пустой атрибут `alt=""`.

---

#### **4. Справочник по разрешенным тегам и их использованию**

##### 4.1. Структура и текст

- **Теги**: `<h1>`-`<h6>`, `<p>`, `<div>`, `<span>`, `<blockquote>`, `<sub>`, `<sup>`, `<b>`, `<i>`, `<u>`, `<br>`, `<hr>`, `<table>`, `<thead>`, `<tbody>`, `<tfoot>`, `<tr>`, `<th>`, `<td>`
    - **Назначение**: Стандартные теги для разметки текста, создания блоков и таблиц.
    - **Правила**: Используются как в обычном HTML, без специфических ограничений.
- **Тег**: `<a>` (Ссылка)
    - **Назначение**: Создание гиперссылок.
    - **⚠️ Критически важные правила**:
        1. Атрибут `target` **обязателен** и должен иметь значение `_blank`.
        2. Атрибут `href` должен указывать на URL с протоколом `http://` или `https://`.
    - **Пример**: `<a href="https://example.com" target="_blank">Наш сайт</a>`

##### 4.2. Медиа

- **Тег**: `<amp-img>`
    - **Назначение**: Отображение изображений. Заменяет стандартный `<img>`.
    - **Правила**:
        1. **Обязательные атрибуты**: `src`, `width`, `height`, `layout`.
        2. `src` должен использовать протокол `https://`.
        3. `layout` определяет, как изображение вписывается в страницу (`responsive`, `fixed`, `fill` и т.д.).
    - **Пример**: `<amp-img src="https://.../image.jpg" width="600" height="400" layout="responsive" alt="Описание изображения"></amp-img>`
- **Тег**: `<amp-anim>`
    - **Назначение**: Для анимированных изображений (GIF).
    - **Правила**: Аналогичны `<amp-img>`.

##### 4.3. Интерактивные компоненты

_Все компоненты в этой секции требуют подключения соответствующего скрипта в `<head>`._

`<amp-accordion>`
**Назначение**: Создание раскрывающихся блоков контента («аккордеон»).
Пример:
```
<amp-accordion>
  <section>
    <h4>Заголовок секции 1</h4>
    <p>Скрытый контент.</p>
  </section>
</amp-accordion>
```

  
`<amp-carousel>`
**Назначение**: Карусель/слайдер для изображений и другого контента.
**Правила**: Требует `width`, `height`, `layout`. Тип задается атрибутом `type="slides"` или `type="carousel"`.
Пример:
```
<amp-carousel width="400" height="300" layout="responsive" type="slides">
  <amp-img src="..." layout="fill" alt="..."></amp-img>
  <amp-img src="..." layout="fill" alt="..."></amp-img> 
</amp-carousel>
```


`<amp-sidebar>`
**Назначение**: Боковая выдвижная панель (например, для меню).

`<amp-list>`
**Назначение**: Загрузка и отображение динамических данных с сервера.
**Правила**:
1. Требует `src` с `https`-URL, который возвращает JSON.
2. Обязательно содержит дочерний `<template type="amp-mustache">` для рендеринга данных.
Пример:
```
<amp-list width="auto" height="100" layout="fixed-height" src="https://.../api/items">
  <template type="amp-mustache">
    <p>Имя: {{name}}, Цена: {{price}}</p>
  </template>
</amp-list>
```
 

`<amp-selector>`, `<amp-image-lightbox>`, `<amp-fit-text>`, `<amp-timeago>`
**Назначение**: Компоненты для создания кастомных селекторов, лайтбоксов, масштабирования текста и отображения времени.

##### 4.4. Формы

`<form>`
**Назначение**: Отправка данных на сервер.
**Правила**:
1. Атрибут `action` запрещен. Вместо него используется `action-xhr` с `https`-URL.
2. Атрибут `target` **обязателен** и должен быть `_top` или `_blank`.
3. Для отображения ответа сервера используются дочерние теги с атрибутами `submit-success` и `submit-error`.

`<input>`, `<select>`, `<option>`, `<textarea>`, `<button>`
**Назначение**: Элементы управления внутри формы. Большинство типов `input` (`text`, `email`, `radio`, `checkbox`, `submit`) разрешены. `image` и `file` запрещены.
##### 4.5. Динамика и события

`<amp-bind>` и `<amp-state>`
**Назначение**: Создание клиентской интерактивности (без JS). `amp-state` хранит JSON-данные (состояние), а `amp-bind` позволяет привязывать атрибуты тегов к этому состоянию.
**Правила**: Привязка к `innerHTML` (`[innerHTML]="..."`) запрещена. Можно использовать `[text]`, `[class]`, `[hidden]` и др.

**Атрибут `on`**:
**Назначение**: Обработка пользовательских событий (`tap`, `change`).
**Правила**: Может вызывать только предопределенные AMP-действия: `myAccordion.toggle()`, `mySidebar.open()`, `AMP.setState(...)`.

---

#### **5. Требования к серверной части (API Endpoints)**

Для компонентов `<amp-list>` и `<form>`, которые взаимодействуют с вашим сервером, **обязательно** соблюдение следующих правил безопасности.

> **⚠️ Внимание!** Это критически важный аспект безопасности. Почтовые клиенты проксируют запросы, и без этих проверок ваши эндпоинты будут уязвимы.

Процесс обработки запроса на сервере:

1. **Проверить CORS-заголовки**: Запрос должен содержать корректные заголовки `Origin` и `AMP-Same-Origin`. Ваше API должно быть настроено на их прием и валидацию.
2. **Проверить отправителя письма**: Почтовый клиент добавит к запросу HTTP-заголовок `AMP-Email-Sender`. Его значение — это email-адрес из поля `From` письма, из которого был сделан запрос. **Ваш сервер должен проверить, что это значение является доверенным email-адресом.**
3. **Вернуть разрешающий заголовок**: В ответе от сервера **обязательно** должен присутствовать заголовок `AMP-Email-Allow-Sender`, значение которого в точности совпадает со значением из полученного `AMP-Email-Sender`.

Если хотя бы одно из этих правил не выполнено, почтовый клиент проигнорирует ответ от вашего сервера.

---

#### **6. Валидация и тестирование**

Перед отправкой каждое письмо должно пройти валидацию.

1. **В браузере**: Добавьте `#development=1` к URL-адресу вашего HTML-файла, открытого локально. Ошибки валидации будут показаны в консоли разработчика.
2. **Онлайн-валидатор**: Используйте официальный валидатор на [validator.amp.dev](https://validator.amp.dev/).
3. **NPM-пакет**: `amphtml-validator` для автоматической проверки в CI/CD.

**Часто встречающиеся ошибки:**

- `<a>` без `target="_blank"`.
- Использование `http://` вместо `https://` для внешних ресурсов.
- Отсутствие `width`, `height` или `layout` у `<amp-img>`.
- Некорректная настройка CORS и заголовков `AMP-Email-Sender` на сервере.
- Превышение лимита CSS в 75 КБ.